// Imports
const { Storage } = require('@google-cloud/storage');
const { BigQuery } = require('@google-cloud/bigquery');

// Entry function
exports.sortFiles = async (file, context) => {
    // Initalize variables and bucket paths
    const storage = new Storage();
    const bq = new BigQuery();
    const maliciousBucket = storage.bucket('malicious-pdf-files');
    const benignBucket = storage.bucket('benign-pdf-files');
    const sourceBucket = storage.bucket('malware-files-to-sort');

    // Get the file name
    const fileName = file.name;

    // Query the database to match the file name and retrieve the class
    const sqlQuery = `SELECT filename, Class FROM \`malware-scanner24.files_to_sort.files_table\` WHERE filename = @filename`;
    const options = {
        query: sqlQuery,
        params: { filename: fileName },
    };

    const [rows] = await bq.query(options);

    // For each file match within the database, log the filename and class
    if (rows.length > 0) {
        for (const row of rows) {
            console.log(`Filename: ${row.filename}, Class: ${row.Class}`);

            // Set the target bucket based on the file class 
            let targetBucket;
            if (row.Class === 'Malicious') {
                targetBucket = maliciousBucket;
            } else {
                targetBucket = benignBucket;
            }

            // Copy the file to the target bucket
            await sourceBucket.file(fileName).copy(targetBucket.file(fileName));
            console.log(`File ${fileName} copied to ${targetBucket.name}`);
        }
    } 
    
    else {
        console.log(`No data found for filename: ${fileName}`);
    }
    
    // Delete the file from the source bucket
    await sourceBucket.file(fileName).delete();
    console.log(`Deleted uploaded file: ${fileName}`);
};